
<style>
  .table .td .description {
    max-width: 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
<div class="container">
  <h1>üìå Project Bookings</h1>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>User</th>
          <th>Project</th>
          <th class="description">Description</th>
          <th>Expected Timeline</th>
          <th>Estimated Budget</th>
          <th>Status</th>
          <th>Quotation</th>
        </tr>
      </thead>

      <tbody>
        <% bookings.forEach(b => { %>
          <tr>
            <td><%= b.fullname %></td>
            <td>
              <%= b.project_title %>
              <% if (!b.project_id) { %>
                <span class="badge info">Custom</span>
              <% } %>
            </td>
            <td><%= b.description || 'N/A' %></td>
            <td><%= b.timeline || 'N/A' %></td>
            <td>
              ‚Ç¶<%= b.expected_budget
                ? parseFloat(b.expected_budget).toLocaleString()
                : 'N/A'
              %> 
            </td>

            <td>
              <span class="status <%= b.status %>"><%= b.status %></span>
            </td>

            <td>
              <% if (!b.quotation_id) { %>
                <button
                  class="btn btn-primary btn-sm"
                  onclick="openQuotationModal(
                    '<%= b.id %>',
                    '<%= b.fullname %>',
                    '<%= b.project_title %>'
                  )"
                >
                  üìÑ Send Quotation
                </button>


              <% } else if (!b.is_locked) { %>

                <button
                  class="btn btn-warning btn-sm"
                  data-booking-id="<%= b.id %>"
                  data-user="<%= b.fullname %>"
                  data-project="<%= b.project_title %>"
                  data-amount="<%= b.quoted_amount %>"
                  data-timeline="<%= b.delivery_timeline %>"
                  data-html="<%- encodeURIComponent(b.quotation_html || '') %>"
                  onclick="openQuotationFromBtn(this)"
                >
                  ‚úèÔ∏è Edit Quotation
                </button>


              <% } else { %>
                <!-- Accepted & locked -->
                <span class="badge danger">üîí Accepted</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>


<div id="quotationModal" class="modal">
  <div class="modal-box">
    <h3 id="quotationTitle">üìÑ Send Quotation</h3>
    <p id="quotationInfo"></p>

    <form action="/admin/projects/quotation" method="POST">
      <input type="hidden" name="booking_id" id="bookingId">

      <label>Quoted Amount</label>
      <input type="number" name="quoted_amount" required>

      <label>Delivery Timeline</label>
      <input type="text" name="delivery_timeline" required>

      <label>Quotation Content</label>
      <textarea name="quotation_html" id="quotationEditor" required></textarea>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeQuotationModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" id="quotationSubmitBtn">
          Send Quotation
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openQuotationFromBtn(btn) {
    const id = btn.dataset.bookingId;
    const user = btn.dataset.user;
    const project = btn.dataset.project;
    const amount = btn.dataset.amount || '';
    const timeline = btn.dataset.timeline || '';
    const html = decodeURIComponent(btn.dataset.html || '');

    openQuotationModal(id, user, project, amount, timeline, html);
  }

  function openQuotationModal(
    id,
    user,
    project,
    amount = '',
    timeline = '',
    html = ''
  ) {
    document.getElementById("bookingId").value = id;

    document.getElementById("quotationInfo").innerText =
      `Quotation for ${user} ‚Äì "${project}"`;

    document.querySelector('[name="quoted_amount"]').value = amount;
    document.querySelector('[name="delivery_timeline"]').value = timeline;

    CKEDITOR.instances.quotationEditor.setData(html);

    if (amount) {
      document.getElementById("quotationTitle").innerText = "‚úèÔ∏è Edit Quotation";
      document.getElementById("quotationSubmitBtn").innerText = "Update Quotation";
    } else {
      document.getElementById("quotationTitle").innerText = "üìÑ Send Quotation";
      document.getElementById("quotationSubmitBtn").innerText = "Send Quotation";
    }

    document.getElementById("quotationModal").style.display = "block";
  }

  function closeQuotationModal() {
    document.getElementById("quotationModal").style.display = "none";
  }

  window.onclick = function (e) {
    const modal = document.getElementById("quotationModal");
    if (e.target === modal) closeQuotationModal();
  };
</script>


<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
<script>
  CKEDITOR.replace("quotationEditor");
</script>
