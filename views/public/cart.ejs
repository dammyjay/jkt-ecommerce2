<!-- <div class="cart-container">
  <h1>Your Cart</h1>

  <% if (cart.items.length === 0) { %>
    <p class="empty-cart">Your cart is empty.</p>
    <a href="/products" class="btn">Continue Shopping</a>
  <% } else { %>

    <div class="cart-grid">
      <% cart.items.forEach(item => { %>
        <div class="cart-item" data-id="<%= item.product_id %>">
          <img src="<%= item.image_url %>" alt="<%= item.name %>">

          <div class="cart-item-info">
            <h4><%= item.name %></h4>
            <p>₦<span class="item-price"><%= (item.price * item.quantity).toLocaleString() %></span></p>

            <input type="number" class="quantity-input" value="<%= item.quantity %>" min="1">

           <button class="remove-item-btn" data-id="<%= item.product_id %>">
                <i class="fa fa-trash"></i>
            </button>

          </div>
        </div>
      <% }) %>
    </div>

    <hr>

    <div class="cart-summary">
      <h3>Total: ₦<span id="cart-total"><%= cart.totalPrice.toLocaleString() %></span></h3>
      <a href="/checkout" class="btn btn-checkout">Proceed to Checkout</a>
    </div>
  <% } %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const cartTotalEl = document.getElementById("cart-total");

  // Update quantity instantly
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', async (e) => {
      const cartItem = e.target.closest('.cart-item');
      const productId = cartItem.dataset.id;
      let quantity = parseInt(e.target.value);
      if (quantity < 1) quantity = 1;
      e.target.value = quantity;

      const res = await fetch('/cart/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId, quantity })
      });

      if (res.ok) {
        const data = await res.json();
        // Update item price
        const itemData = data.cart.items.find(i => i.product_id == productId);
        cartItem.querySelector('.item-price').textContent = (itemData.price * itemData.quantity).toLocaleString();
        // Update total price
        cartTotalEl.textContent = data.cart.totalPrice.toLocaleString();
      }
    });
  });

  // Remove item instantly
  document.querySelectorAll('.remove-item-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const cartItem = btn.closest('.cart-item');
      const productId = btn.dataset.id;

      const res = await fetch('/cart/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId })
      });

      if (res.ok) {
        const data = await res.json();
        // Remove item from DOM
        cartItem.remove();
        // Update total
        cartTotalEl.textContent = data.cart.totalPrice.toLocaleString();
        // Reload if cart empty
        if (data.cart.items.length === 0) location.reload();
      }
    });
  });
});
</script> -->


<!-- <div class="cart-container">
  <h1>Your Cart</h1>

  <% if (cart.items.length === 0) { %>
    <p class="empty-cart">Your cart is empty.</p>
    <a href="/products" class="btn">Continue Shopping</a>
  <% } else { %>

    <div class="cart-grid">
      <% cart.items.forEach(item => { %>
        <div class="cart-item" data-id="<%= item.product_id %>">
          <img src="<%= item.image_url %>" alt="<%= item.name %>">

          <div class="cart-item-info">
            <h4><%= item.name %></h4>
            <p>₦<span class="item-price"><%= (item.price * item.quantity).toLocaleString() %></span></p>

            <input type="number" class="quantity-input" value="<%= item.quantity %>" min="1">

            <button class="remove-item-btn" data-id="<%= item.product_id %>" data-name="<%= item.name %>">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>
      <% }) %>
    </div>

    <hr>

    <div class="cart-summary">
      <h3>Total: ₦<span id="cart-total"><%= cart.totalPrice.toLocaleString() %></span></h3>
       <a href="/cart/checkout" class="btn btn-checkout">Proceed to Checkout</a>

    </div>
  <% } %>
</div>


<div id="deleteModal" class="modal" style="display: none;">
  <div class="modal-content delete-modal">
    <span class="close" onclick="closeDeleteModal()">&times;</span>

    <h3>Delete Product</h3>
    <p>
      Are you sure you want to delete  
      <strong id="deleteProductName"></strong>?
    </p>

    <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
    <button type="button" class="btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
  </div>
</div> -->


<div class="container cart-container">
  <h1>Your Cart</h1>

  <% if (cart.items.length === 0) { %>
    <p class="empty-cart">Your cart is empty.</p>
    <a href="/products" class="btn btn-primary">Continue Shopping</a>
  <% } else { %>

    <div class="cart-grid">
      <% cart.items.forEach(item => { %>
        <div class="cart-item card" data-id="<%= item.product_id %>">

          <img src="<%= item.image_url %>" alt="<%= item.name %>">

          <div class="cart-item-info">
            <h4><%= item.name %></h4>

            <p>
              ₦<span class="item-price">
                <%= (item.price * item.quantity).toLocaleString() %>
              </span>
            </p>

            <!-- Quantity -->
            <input
              type="number"
              class="quantity-input"
              value="<%= item.quantity %>"
              min="1"
            >

            <!-- Remove -->
            <button
              type="button"
              class="btn btn-danger remove-item-btn"
              data-id="<%= item.product_id %>"
              data-name="<%= item.name %>"
            >
              <i class="fa fa-trash"></i>
              Remove
            </button>
          </div>

        </div>
      <% }) %>
    </div>

    <hr>

    <div class="cart-summary card">
      <h3>
        Total:
        ₦<span id="cart-total">
          <%= cart.totalPrice.toLocaleString() %>
        </span>
      </h3>

      <a href="/cart/checkout" class="btn btn-primary">
        Proceed to Checkout
      </a>
    </div>

  <% } %>
</div>


<div id="deleteModal" class="modal">
  <div class="modal-box center small">

    <h3>Delete Product</h3>

    <p>
      Are you sure you want to delete
      <strong id="deleteProductName"></strong>?
    </p>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
        Cancel
      </button>

      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
        Yes, Delete
      </button>
    </div>

  </div>
</div>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const cartTotalEl = document.getElementById("cart-total");
  const deleteModal = document.getElementById("deleteModal");
  const deleteProductName = document.getElementById("deleteProductName");
  const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
  let deleteProductId = null;
  let deleteCartItemEl = null;

  // Update quantity instantly
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', async (e) => {
      const cartItem = e.target.closest('.cart-item');
      const productId = cartItem.dataset.id;
      let quantity = parseInt(e.target.value);
      if (quantity < 1) quantity = 1;
      e.target.value = quantity;

      const res = await fetch('/cart/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId, quantity })
      });

      if (res.ok) {
        const data = await res.json();
        const itemData = data.cart.items.find(i => i.product_id == productId);
        cartItem.querySelector('.item-price').textContent = (itemData.price * itemData.quantity).toLocaleString();
        cartTotalEl.textContent = data.cart.totalPrice.toLocaleString();
      }
    });
  });

  // Open delete modal
  document.querySelectorAll('.remove-item-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      deleteProductId = btn.dataset.id;
      deleteCartItemEl = btn.closest('.cart-item');
      deleteProductName.textContent = btn.dataset.name;
      deleteModal.style.display = 'block';
    });
  });

  // Confirm delete
  confirmDeleteBtn.addEventListener('click', async () => {
    if (!deleteProductId) return;

    const res = await fetch('/cart/remove', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ product_id: deleteProductId })
    });

    if (res.ok) {
      const data = await res.json();
      deleteCartItemEl.remove();
      cartTotalEl.textContent = data.cart.totalPrice.toLocaleString();
      deleteModal.style.display = 'none';

      // Reload if cart empty
      if (data.cart.items.length === 0) location.reload();
    }
  });

  // Close modal function
  window.closeDeleteModal = () => {
    deleteModal.style.display = 'none';
    deleteProductId = null;
    deleteCartItemEl = null;
  };

  // Close modal when clicking outside
  window.addEventListener('click', e => {
    if (e.target === deleteModal) closeDeleteModal();
  });
});
</script>
